{% csrf_token %}
{% load static %}
<!DOCTYPE html>
<html class="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Golf Stats App</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <link href="{% static 'GolfStatsApp/style.css' %}" rel="stylesheet">
</head>

<body class="container">
    <header class="center">
        <div>
            <h2>Golf Stats</h2>
        </div>
        <div>
            {% if user.is_authenticated %}
            <h3>Welcome, {{ user.username }}!</h3>
            <nav>
                <a href="#rounds">Rounds</a>
                <a href="#addround">Add Round</a>
                <a href="{% url 'logout' %}">Logout</a>
                <!-- <a href="#top">Return to Top</a> -->
            </nav>
        </div>
    </header>

    <div id="app">
        <div class="card-panel grey lighten-5 z-depth-1" class="col s12">
            <table class="col s12">
                <caption><h4>Averages Across All Rounds</h4></caption>
                <tr>
                    <th>Avg Score</th>
                    <th>Avg GIR</th>
                    <th>Avg FIR</th>
                    <th>Avg Putts</th>
                </tr>
                <tr>
                    <td>[[ avg_score ]]</td>
                    <td>[[ avg_greens ]]%</td>
                    <td>[[ avg_fairways ]]%</td>
                    <td>[[ avg_putts ]]</td>
                </tr>
            </table>
        </div>
        <div class="col s12" id='rounds'>
            <div class="card-panel grey lighten-5 z-depth-1">
                <table>
                <caption><h4>Rounds Added</h4></caption>
                <tr>
                    <th>Course</th>
                    <th>Score</th>
                    <th>GIR</th>
                    <th>FIR</th>
                    <th>Putts</th>
                    <th>Delete</th>
                </tr>
                    <tr v-for="round in rounds" v-bind:key="round.id">
                        <td>[[ round.course ]] - Par [[ round.par ]]</td>
                        <td>[[ round.score ]]</td>
                        <td>[[ round.greens_percentage ]]%</td>
                        <td>[[ round.fairways_percentage ]]%</td>
                        <td>[[ round.putts ]]</td>
                        <td><button @click="deleteRound(round)">Delete Round</button></td>
                    </tr>
                </table>
            </div>
        </div>
        <div class="card-panel grey lighten-5 z-depth-1">
            <div class="col s12" id='addround'>
                <h4>Add a Round</h4>
                <p>Course Name</p>
                <input v-model="course">

                <p>Par for the Course</p>
                <input v-model="par">

                <p>Your Score</p>
                <input v-model="score">

                <p>Greens in Regulation</p>
                <input v-model="greens">

                <p>Total Course Fairways</p>
                <input v-model="total_fairways">

                <p>Fairways Hit</p>
                <input v-model="fairways_hit">

                <p>Putts</p>
                <input v-model="putts">
                <br>
                <button @click="addRound">Add Round</button>
            </div>
        </div>
    </div>
    <div>
        {% else %}
        <h1>Welcome!</h1>
        <p>You are not logged in. <a href="{% url 'login' %}">Login</a> <a href="{% url 'users:signup' %}">Sign Up</a>
        </p>
        {% endif %}
    </div>
    <div class="card-panel grey lighten-5 z-depth-1">
        <footer class="center">
            <f3>Deezy Golf Co.&#174; </f3>
        </footer>
    </div>

    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
    <script>
        let vm = new Vue({
            el: '#app',
            delimiters: ['[[', ']]'],
            data: {
                rounds: [],
                course: '',
                score: '',
                par: '',
                greens: '',
                total_fairways: '',
                fairways_hit: '',
                putts: '',
                avg_score: '',
                avg_greens: '',
                avg_fairways: '',
                avg_putts: '',
            },
            mounted: function () {

                this.getRounds();
            },
            methods: {

                // runningTotal: function () {
                //     axios({
                //         method: 'get',
                //         url: 'api/v1/',
                //     }).then(response => {
                //         console.log(response)
                //         // this.avg_score = 
                //     })
                // },

                getRounds: function () {
                    axios({
                        method: 'get',
                        url: 'api/v1/',
                    }).then(response => {
                        console.log(response);
                        this.rounds = response.data.filter(round => round.user === {{ user.id }})
                    let scoreArray = []
                    let greensArray = []
                    let fairwaysArray = []
                    let puttsArray = []
                    const arrAvg = arr => arr.reduce((a, b) => a + b, 0) / arr.length

                    this.rounds.forEach(round => {
                        scoreArray.push(round.score)
                        greensArray.push(round.greens_percentage)
                        fairwaysArray.push(round.fairways_percentage)
                        puttsArray.push(round.putts)
                    }),
                        this.avg_score = arrAvg(scoreArray).toPrecision(3)
                    this.avg_greens = arrAvg(greensArray).toPrecision(4)
                    this.avg_fairways = arrAvg(fairwaysArray).toPrecision(4)
                    this.avg_putts = arrAvg(puttsArray).toPrecision(3)

                })
                    },

        addRound: function () {
            let csrf_token = document.querySelector("input[name=csrfmiddlewaretoken]").value;
            axios({
                url: '/api/v1/',
                method: 'post',
                headers: {
                    'X-CSRFToken': csrf_token
                },
                data: {
                    user: {{ user.id }},
        course: this.course,
            par: this.par,
                score: this.score,
                    greens: this.greens,
                        total_fairways: this.total_fairways,
                            fairways_hit: this.fairways_hit,
                                putts: this.putts,
                        }
                        }).then(response => {
                                    this.getRounds()
                                })
                },
        deleteRound: function (round) {
            let csrf_token = document.querySelector("input[name=csrfmiddlewaretoken]").value;
            axios({
                url: '/api/v1/' + round.id,
                method: 'delete',
                headers: {
                    'X-CSRFToken': csrf_token
                },
            }).then(response => {
                this.getRounds()
            })
        },
        },
        })
    </script>
</body>

</html>